{% if do_slowgain_solve %}
pipeline.steps = [update_mapfile_hosts, create_timechunk_files_map, create_freqchunk_files_map, create_starttime_map, create_ntimes_map, create_slow_starttime_map, create_slow_ntimes_map, create_startchan_map, create_nchan_map, create_fast_timestep_map, create_fast_timestep_core_map, create_fast_timestep_remote_map, create_slow_timestep_map, create_fast_freqstep_map, create_slow_freqstep_map, create_fast_h5parms_map, create_fast_core_h5parms_map, create_fast_remote_h5parms_map, create_slow_h5parms_map, {% if not use_idg_predict %} create_skymodel_map, make_sourcedb, expand_sourcedb_mapfile_time, expand_sourcedb_mapfile_freq,  {% endif %} {% if solve_core_separately %} solve_fast_phases1, create_compressed_mapfile_fast_core, create_fast_core_output_map, combine_fast_phases_core, reset_remote, expand_fast_phases_core_mapfile, solve_fast_phases2, create_compressed_mapfile_fast_remote, create_fast_remote_output_map, combine_fast_phases_remote, create_fast_output_map, combine_fast_phases, {% else %} solve_fast_phases, create_compressed_mapfile_fast, create_fast_output_map, combine_fast_phases, {% endif %} fit_fast_screens, create_fast_aterms_output_map, make_fast_aterms, expand_fast_phases_mapfile, solve_slow_gains, create_compressed_mapfile_slow, create_slow_output_map, combine_slow_gains, fit_slow_screens, create_slow_aterms_output_map, make_slow_aterms, create_combined_output_map, combine_h5parms]
{% else %}
pipeline.steps = [update_mapfile_hosts, create_timechunk_files_map, create_starttime_map, create_ntimes_map, create_fast_timestep_map, create_slow_timestep_map, create_fast_freqstep_map, create_fast_h5parms_map, {% if not use_idg_predict %}
create_skymodel_map, make_sourcedb, expand_sourcedb_mapfile_time, expand_sourcedb_mapfile_freq, {% endif %} solve_fast_phases, create_compressed_mapfile_fast, create_fast_output_map, combine_fast_phases, fit_fast_screens]
{% endif %}

pipeline.pluginpath = {{ pipeline_dir }}/plugins

# update host entries in all mapfiles
update_mapfile_hosts.control.kind        = plugin
update_mapfile_hosts.control.type        = updateHosts
update_mapfile_hosts.control.mapfile_dir = input.output.mapfile_dir
update_mapfile_hosts.control.hosts       = {{ hosts }}

# create a mapfile of each time chunk's filename, length = ntimechunks
create_timechunk_files_map.control.kind        = plugin
create_timechunk_files_map.control.type        = addListMapfile
create_timechunk_files_map.control.hosts       = {{ hosts }}
create_timechunk_files_map.control.files       = {{ timechunk_filename }}
create_timechunk_files_map.control.mapfile_dir = input.output.mapfile_dir
create_timechunk_files_map.control.filename    = timefiles.mapfile

# create a mapfile of each frequency chunk's filename, length = nfreqchunks
create_freqchunk_files_map.control.kind        = plugin
create_freqchunk_files_map.control.type        = addListMapfile
create_freqchunk_files_map.control.hosts       = {{ hosts }}
create_freqchunk_files_map.control.files       = {{ freqchunk_filename }}
create_freqchunk_files_map.control.mapfile_dir = input.output.mapfile_dir
create_freqchunk_files_map.control.filename    = freqfiles.mapfile

# create a mapfile with each time chunk's starttime value, length = ntimechunks
create_starttime_map.control.kind        = plugin
create_starttime_map.control.type        = addListMapfile
create_starttime_map.control.hosts       = {{ hosts }}
create_starttime_map.control.files       = {{ starttime }}
create_starttime_map.control.mapfile_dir = input.output.mapfile_dir
create_starttime_map.control.filename    = starttime.mapfile

# create a mapfile with each time chunk's ntimes value, length = ntimechunks
create_ntimes_map.control.kind        = plugin
create_ntimes_map.control.type        = addListMapfile
create_ntimes_map.control.hosts       = {{ hosts }}
create_ntimes_map.control.files       = {{ ntimes }}
create_ntimes_map.control.mapfile_dir = input.output.mapfile_dir
create_ntimes_map.control.filename    = ntimes.mapfile

# create a mapfile with each time chunk's starttime value, length = ntimechunks
create_slow_starttime_map.control.kind        = plugin
create_slow_starttime_map.control.type        = addListMapfile
create_slow_starttime_map.control.hosts       = {{ hosts }}
create_slow_starttime_map.control.files       = {{ slow_starttime }}
create_slow_starttime_map.control.mapfile_dir = input.output.mapfile_dir
create_slow_starttime_map.control.filename    = slow_starttime.mapfile

# create a mapfile with each time chunk's ntimes value, length = ntimechunks
create_slow_ntimes_map.control.kind        = plugin
create_slow_ntimes_map.control.type        = addListMapfile
create_slow_ntimes_map.control.hosts       = {{ hosts }}
create_slow_ntimes_map.control.files       = {{ slow_ntimes }}
create_slow_ntimes_map.control.mapfile_dir = input.output.mapfile_dir
create_slow_ntimes_map.control.filename    = slow_ntimes.mapfile

# create a mapfile with each frequency chunk's startchan value, length = nfreqchunks*nobs
create_startchan_map.control.kind        = plugin
create_startchan_map.control.type        = addListMapfile
create_startchan_map.control.hosts       = {{ hosts }}
create_startchan_map.control.files       = {{ startchan }}
create_startchan_map.control.mapfile_dir = input.output.mapfile_dir
create_startchan_map.control.filename    = startchan.mapfile

# create a mapfile with each frequency chunk's nchan value, length = nfreqchunks*nobs
create_nchan_map.control.kind        = plugin
create_nchan_map.control.type        = addListMapfile
create_nchan_map.control.hosts       = {{ hosts }}
create_nchan_map.control.files       = {{ nchan }}
create_nchan_map.control.mapfile_dir = input.output.mapfile_dir
create_nchan_map.control.filename    = nchan.mapfile

# create a mapfile with each time chunk's fast_timestep value, length = ntimechunks*nobs
create_fast_timestep_map.control.kind        = plugin
create_fast_timestep_map.control.type        = addListMapfile
create_fast_timestep_map.control.hosts       = {{ hosts }}
create_fast_timestep_map.control.files       = {{ solint_fast_timestep }}
create_fast_timestep_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_timestep_map.control.filename    = fast_timestep.mapfile

# create a mapfile with each time chunk's fast_timestep_core value, length = ntimechunks*nobs
create_fast_timestep_core_map.control.kind        = plugin
create_fast_timestep_core_map.control.type        = addListMapfile
create_fast_timestep_core_map.control.hosts       = {{ hosts }}
create_fast_timestep_core_map.control.files       = {{ solint_fast_timestep_core }}
create_fast_timestep_core_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_timestep_core_map.control.filename    = fast_timestep_core.mapfile

# create a mapfile with each time chunk's fast_timestep_remote value, length = ntimechunks*nobs
create_fast_timestep_remote_map.control.kind        = plugin
create_fast_timestep_remote_map.control.type        = addListMapfile
create_fast_timestep_remote_map.control.hosts       = {{ hosts }}
create_fast_timestep_remote_map.control.files       = {{ solint_fast_timestep_remote }}
create_fast_timestep_remote_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_timestep_remote_map.control.filename    = fast_timestep_remote.mapfile

# create a mapfile with each frequency chunk's slow_timestep value, length = nfreqchunks*nobs
create_slow_timestep_map.control.kind        = plugin
create_slow_timestep_map.control.type        = addListMapfile
create_slow_timestep_map.control.hosts       = {{ hosts }}
create_slow_timestep_map.control.files       = {{ solint_slow_timestep }}
create_slow_timestep_map.control.mapfile_dir = input.output.mapfile_dir
create_slow_timestep_map.control.filename    = slow_timestep.mapfile

# create a mapfile with each time chunk's fast_freqstep value, length = ntimechunks
create_fast_freqstep_map.control.kind        = plugin
create_fast_freqstep_map.control.type        = addListMapfile
create_fast_freqstep_map.control.hosts       = {{ hosts }}
create_fast_freqstep_map.control.files       = {{ solint_fast_freqstep }}
create_fast_freqstep_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_freqstep_map.control.filename    = fast_freqstep.mapfile

# create a mapfile with each frequency chunk's slow_freqstep value, length = nfreqchunks*nobs
create_slow_freqstep_map.control.kind        = plugin
create_slow_freqstep_map.control.type        = addListMapfile
create_slow_freqstep_map.control.hosts       = {{ hosts }}
create_slow_freqstep_map.control.files       = {{ solint_slow_freqstep }}
create_slow_freqstep_map.control.mapfile_dir = input.output.mapfile_dir
create_slow_freqstep_map.control.filename    = slow_freqstep.mapfile

# create a mapfile with the output fast-phase h5parms from supplied list, length = ntimechunks
create_fast_h5parms_map.control.kind        = plugin
create_fast_h5parms_map.control.type        = addListMapfile
create_fast_h5parms_map.control.hosts       = {{ hosts }}
create_fast_h5parms_map.control.files       = {{ output_fast_h5parm }}
create_fast_h5parms_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_h5parms_map.control.filename    = fast_h5parms.mapfile

# create a mapfile with the output fast-phase (core) h5parms from supplied list, length = ntimechunks
create_fast_core_h5parms_map.control.kind        = plugin
create_fast_core_h5parms_map.control.type        = addListMapfile
create_fast_core_h5parms_map.control.hosts       = {{ hosts }}
create_fast_core_h5parms_map.control.files       = {{ output_fast_core_h5parm }}
create_fast_core_h5parms_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_core_h5parms_map.control.filename    = fast_core_h5parms.mapfile

# create a mapfile with the output fast-phase (remote) h5parms from supplied list, length = ntimechunks
create_fast_remote_h5parms_map.control.kind        = plugin
create_fast_remote_h5parms_map.control.type        = addListMapfile
create_fast_remote_h5parms_map.control.hosts       = {{ hosts }}
create_fast_remote_h5parms_map.control.files       = {{ output_fast_remote_h5parm }}
create_fast_remote_h5parms_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_remote_h5parms_map.control.filename    = fast_remote_h5parms.mapfile

# create a mapfile with the output slow-gain h5parms from supplied list, length = nfreqchunks*nobs
create_slow_h5parms_map.control.kind        = plugin
create_slow_h5parms_map.control.type        = addListMapfile
create_slow_h5parms_map.control.hosts       = {{ hosts }}
create_slow_h5parms_map.control.files       = {{ output_slow_h5parm }}
create_slow_h5parms_map.control.mapfile_dir = input.output.mapfile_dir
create_slow_h5parms_map.control.filename    = slow_h5parms.mapfile

{% if not use_idg_predict %}
# create a mapfile with the current skymodel, length = 1
create_skymodel_map.control.kind        = plugin
create_skymodel_map.control.type        = addListMapfile
create_skymodel_map.control.hosts       = {{ hosts }}
create_skymodel_map.control.files       = [{{ calibration_skymodel_file }}]
create_skymodel_map.control.mapfile_dir = input.output.mapfile_dir
create_skymodel_map.control.filename    = skymodels.mapfile

# convert the skymodel into a sourcedb, length = 1
make_sourcedb.control.type       = make_sourcedb
make_sourcedb.control.mapfile_in = create_skymodel_map.output.mapfile
make_sourcedb.control.inputkey   = in
make_sourcedb.argument.format    = <
make_sourcedb.argument.outtype   = blob
make_sourcedb.argument.append    = False

# expand the sourcedb mapfile so that there is one entry for every time chunk, length = ntimechunks
expand_sourcedb_mapfile_time.control.kind             = plugin
expand_sourcedb_mapfile_time.control.type             = expandMapfile
expand_sourcedb_mapfile_time.control.mapfile_in       = make_sourcedb.output.mapfile
expand_sourcedb_mapfile_time.control.mapfile_to_match = create_timechunk_files_map.output.mapfile
expand_sourcedb_mapfile_time.control.mapfile_dir      = input.output.mapfile_dir
expand_sourcedb_mapfile_time.control.filename         = expand_sourcedb_time.mapfile

# expand the sourcedb mapfile so that there is one entry for every frequency chunk, length = nfreqchunks*nobs
expand_sourcedb_mapfile_freq.control.kind             = plugin
expand_sourcedb_mapfile_freq.control.type             = expandMapfile
expand_sourcedb_mapfile_freq.control.mapfile_in       = make_sourcedb.output.mapfile
expand_sourcedb_mapfile_freq.control.mapfile_to_match = create_freqchunk_files_map.output.mapfile
expand_sourcedb_mapfile_freq.control.mapfile_dir      = input.output.mapfile_dir
expand_sourcedb_mapfile_freq.control.filename         = expand_sourcedb_freq.mapfile
{% endif %}

# smooth with baseline-dependent weights?

# solve for fast phases (true phase, not tec), do clock-TEC separation per direction to
# find delay+offset, then proceed with normal tec solves while applying the delays+offsets?
# This should remove direction-dependent delays during solve, but we also need to apply
# them during imaging with screens

{% if solve_core_separately %}

# solve for fast phases (core stations only), length = ntimechunks
solve_fast_phases1.control.type                      = dppp_inplace
{% if use_idg_predict %}
solve_fast_phases1.control.mapfiles_in               = [create_timechunk_files_map.output.mapfile,create_fast_core_h5parms_map.output.mapfile,create_starttime_map.output.mapfile,create_ntimes_map.output.mapfile,create_fast_timestep_core_map.output.mapfile,create_fast_freqstep_map.output.mapfile]
solve_fast_phases1.control.inputkeys                 = [msin,h5parm,starttime,ntimes,timestep,freqstep]
{% else %}
solve_fast_phases1.control.mapfiles_in               = [create_timechunk_files_map.output.mapfile,create_fast_core_h5parms_map.output.mapfile,create_starttime_map.output.mapfile,create_ntimes_map.output.mapfile,create_fast_timestep_core_map.output.mapfile,create_fast_freqstep_map.output.mapfile,expand_sourcedb_mapfile_time.output.mapfile]
solve_fast_phases1.control.inputkeys                 = [msin,h5parm,starttime,ntimes,timestep,freqstep,sourcedb]
{% endif %}
solve_fast_phases1.control.max_per_node              = 1
solve_fast_phases1.argument.numthreads               = {{ max_proc_per_node }}
solve_fast_phases1.argument.msin.datacolumn          = {{ data_colname }}
solve_fast_phases1.argument.msin.starttime           = starttime
solve_fast_phases1.argument.msin.ntimes              = ntimes
solve_fast_phases1.argument.msin.baseline            = {{ baselines_core }}
solve_fast_phases1.argument.msout                    = .
solve_fast_phases1.argument.steps                    = [solve]
solve_fast_phases1.argument.solve.type               = ddecal
solve_fast_phases1.argument.solve.mode               = {{ mode }}
{% if mode == 'tecscreen' %}
solve_fast_phases1.argument.solve.tecscreen.order    = {{ tecscreenorder }}
solve_fast_phases1.argument.solve.tecscreen.mode     = station
{% endif %}
{% if use_beam %}
solve_fast_phases1.argument.solve.usebeammodel       = True
solve_fast_phases1.argument.solve.beammode           = array_factor
solve_fast_phases1.argument.solve.onebeamperpatch    = True
{% endif %}
solve_fast_phases1.argument.solve.h5parm             = h5parm
solve_fast_phases1.argument.solve.solint             = timestep
solve_fast_phases1.argument.solve.nchan              = freqstep
{% if mode == 'tec' %}
solve_fast_phases1.argument.solve.approximatetec     = {{ approximatetec }}
solve_fast_phases1.argument.solve.maxapproxiter      = {{ maxapproxiter }}
# solve_fast_phases.argument.solve.approxchunksize    = 5
{% endif %}
solve_fast_phases1.argument.solve.maxiter            = {{ maxiter }}
solve_fast_phases1.argument.solve.propagatesolutions = {{ propagatesolutions }}
solve_fast_phases1.argument.solve.stepsize           = {{ stepsize }}
solve_fast_phases1.argument.solve.tolerance          = {{ tolerance }}
solve_fast_phases1.argument.solve.uvlambdamin        = {{ solve_min_uv_lambda }}
solve_fast_phases1.argument.solve.antennaconstraint  = {{ antennaconstraint_core }}
{% if use_idg_predict %}
solve_fast_phases1.argument.solve.useidg             = True
solve_fast_phases1.argument.solve.idg.image          = {{ model_image_file }}
solve_fast_phases1.argument.solve.idg.regions        = {{ model_regions_file }}
{% else %}
solve_fast_phases1.argument.solve.sourcedb           = sourcedb
{% endif %}

# compress fast-phase (core) mapfile so that all files are in one group, length = 1
create_compressed_mapfile_fast_core.control.kind        = plugin
create_compressed_mapfile_fast_core.control.type        = compressMapfile
create_compressed_mapfile_fast_core.control.mapfile_in  = create_fast_core_h5parms_map.output.mapfile
create_compressed_mapfile_fast_core.control.mapfile_dir = input.output.mapfile_dir
create_compressed_mapfile_fast_core.control.filename    = compress_fast_core.mapfile

# create a mapfile for output of combine step, length = 1
create_fast_core_output_map.control.kind        = plugin
create_fast_core_output_map.control.type        = addListMapfile
create_fast_core_output_map.control.hosts       = {{ hosts }}
create_fast_core_output_map.control.files       = [input.output.working_directory/input.output.job_name/fast_phases_core.h5]
create_fast_core_output_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_core_output_map.control.filename    = combine_fast_core_h5parms_output.mapfile

# collect all the fast-phase (core) solutions, length = ntimechunks -> 1
combine_fast_phases_core.control.type        = collect_h5parms
combine_fast_phases_core.control.mapfile_in  = create_compressed_mapfile_fast_core.output.mapfile
combine_fast_phases_core.control.inputkey    = infiles
combine_fast_phases_core.control.mapfile_out = create_fast_core_output_map.output.mapfile
combine_fast_phases_core.control.outputkey   = outfile
combine_fast_phases_core.argument.flags      = [-c,infiles]
combine_fast_phases_core.argument.outh5parm  = outfile
{% if mode == 'tecscreen' %}
combine_fast_phases_core.argument.insoltab   = tec000
{% endif %}

# reset remote stations before next solve, length = 1
reset_remote.control.type        = reset_h5parm
reset_remote.control.mapfile_in  = combine_fast_phases_core.output.mapfile
reset_remote.control.inputkey    = infile
reset_remote.argument.flags      = [infile,{{ baselines_core }}]
reset_remote.argument.soltab     = tec000

# expand the fast-phase mapfile so that there is one entry for every frequency chunk, length = nfreqchunks*nobs
expand_fast_phases_core_mapfile.control.kind             = plugin
expand_fast_phases_core_mapfile.control.type             = expandMapfile
expand_fast_phases_core_mapfile.control.mapfile_in       = combine_fast_phases_core.output.mapfile
expand_fast_phases_core_mapfile.control.mapfile_to_match = create_timechunk_files_map.output.mapfile
expand_fast_phases_core_mapfile.control.mapfile_dir      = input.output.mapfile_dir
expand_fast_phases_core_mapfile.control.filename         = expand_fastphase_core_time.mapfile

# solve for fast phases (remote stations), length = ntimechunks
solve_fast_phases2.control.type                      = dppp_inplace
{% if use_idg_predict %}
solve_fast_phases2.control.mapfiles_in               = [create_timechunk_files_map.output.mapfile,create_fast_remote_h5parms_map.output.mapfile,create_starttime_map.output.mapfile,create_ntimes_map.output.mapfile,create_fast_timestep_remote_map.output.mapfile,create_fast_freqstep_map.output.mapfile,expand_fast_phases_core_mapfile.output.mapfile]
solve_fast_phases2.control.inputkeys                 = [msin,h5parm,starttime,ntimes,timestep,freqstep,fast_core_h5parm]
{% else %}
solve_fast_phases2.control.mapfiles_in               = [create_timechunk_files_map.output.mapfile,create_fast_remote_h5parms_map.output.mapfile,create_starttime_map.output.mapfile,create_ntimes_map.output.mapfile,create_fast_timestep_remote_map.output.mapfile,create_fast_freqstep_map.output.mapfile,expand_sourcedb_mapfile_time.output.mapfile,expand_fast_phases_core_mapfile.output.mapfile]
solve_fast_phases2.control.inputkeys                 = [msin,h5parm,starttime,ntimes,timestep,freqstep,sourcedb,fast_core_h5parm]
{% endif %}
solve_fast_phases2.control.max_per_node              = 1
solve_fast_phases2.argument.numthreads               = {{ max_proc_per_node }}
solve_fast_phases2.argument.msin.datacolumn          = {{ data_colname }}
solve_fast_phases2.argument.msin.starttime           = starttime
solve_fast_phases2.argument.msin.ntimes              = ntimes
solve_fast_phases2.argument.msout                    = .
solve_fast_phases2.argument.steps                    = [solve]
solve_fast_phases2.argument.solve.type               = ddecal
solve_fast_phases2.argument.solve.mode               = {{ mode }}
{% if mode == 'tecscreen' %}
solve_fast_phases2.argument.solve.tecscreen.order    = {{ tecscreenorder }}
solve_fast_phases2.argument.solve.tecscreen.mode     = station
{% endif %}
{% if use_beam %}
solve_fast_phases2.argument.solve.usebeammodel       = True
solve_fast_phases2.argument.solve.beammode           = array_factor
{% endif %}
solve_fast_phases2.argument.solve.h5parm             = h5parm
solve_fast_phases2.argument.solve.sourcedb           = sourcedb
solve_fast_phases2.argument.solve.solint             = timestep
solve_fast_phases2.argument.solve.nchan              = freqstep
{% if mode == 'tec' %}
solve_fast_phases2.argument.solve.approximatetec     = {{ approximatetec }}
solve_fast_phases2.argument.solve.maxapproxiter      = {{ maxapproxiter }}
# solve_fast_phases.argument.solve.approxchunksize    = 5
{% endif %}
solve_fast_phases2.argument.solve.applycal.parmdb           = fast_core_h5parm
solve_fast_phases2.argument.solve.applycal.correction       = tec000
solve_fast_phases2.argument.solve.maxiter            = {{ maxiter }}
solve_fast_phases2.argument.solve.propagatesolutions = {{ propagatesolutions }}
solve_fast_phases2.argument.solve.stepsize           = {{ stepsize }}
solve_fast_phases2.argument.solve.tolerance          = {{ tolerance }}
solve_fast_phases2.argument.solve.uvlambdamin        = {{ solve_min_uv_lambda }}
solve_fast_phases2.argument.solve.antennaconstraint  = {{ antennaconstraint_remote }}
{% if use_idg_predict %}
solve_fast_phases2.argument.solve.useidg             = True
solve_fast_phases2.argument.solve.idg.image          = {{ model_image_file }}
solve_fast_phases2.argument.solve.idg.regions        = {{ model_regions_file }}
{% endif %}

# compress fast-phase (remote) mapfile so that all files are in one group, length = 1
create_compressed_mapfile_fast_remote.control.kind        = plugin
create_compressed_mapfile_fast_remote.control.type        = compressMapfile
create_compressed_mapfile_fast_remote.control.mapfile_in  = create_fast_remote_h5parms_map.output.mapfile
create_compressed_mapfile_fast_remote.control.mapfile_dir = input.output.mapfile_dir
create_compressed_mapfile_fast_remote.control.filename    = compress_fast_remote.mapfile

# create a mapfile for output of combine step, length = 1
create_fast_remote_output_map.control.kind        = plugin
create_fast_remote_output_map.control.type        = addListMapfile
create_fast_remote_output_map.control.hosts       = {{ hosts }}
create_fast_remote_output_map.control.files       = [input.output.working_directory/input.output.job_name/fast_phases_remote.h5]
create_fast_remote_output_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_remote_output_map.control.filename    = combine_fast_remote_h5parms_output.mapfile

# collect all the fast-phase (remote) solutions, length = ntimechunks -> 1
combine_fast_phases_remote.control.type        = collect_h5parms
combine_fast_phases_remote.control.mapfile_in  = create_compressed_mapfile_fast_remote.output.mapfile
combine_fast_phases_remote.control.inputkey    = infiles
combine_fast_phases_remote.control.mapfile_out = create_fast_remote_output_map.output.mapfile
combine_fast_phases_remote.control.outputkey   = outfile
combine_fast_phases_remote.argument.flags      = [-c,infiles]
combine_fast_phases_remote.argument.outh5parm  = outfile
{% if mode == 'tecscreen' %}
combine_fast_phases_remote.argument.insoltab   = tec000
{% endif %}

# create a mapfile for output of combine step, length = 1
create_fast_output_map.control.kind        = plugin
create_fast_output_map.control.type        = addListMapfile
create_fast_output_map.control.hosts       = {{ hosts }}
create_fast_output_map.control.files       = [input.output.working_directory/input.output.job_name/fast_phases.h5]
create_fast_output_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_output_map.control.filename    = combine_fast_h5parms_output.mapfile

# combine core and remote fast-phase solutions, length = 2 -> 1
combine_fast_phases.control.type        = combine_h5parms
combine_fast_phases.control.mapfiles_in = [combine_fast_phases_core.output.mapfile,combine_fast_phases_remote.output.mapfile]
combine_fast_phases.control.inputkeys   = [h1,h2]
combine_fast_phases.control.mapfile_out = create_fast_output_map.output.mapfile
combine_fast_phases.control.outputkey   = outfile
combine_fast_phases.argument.flags      = [h1,h2,outfile]
combine_fast_phases.argument.add_values = True

{% else %}

# solve for fast phases (all stations), length = ntimechunks
solve_fast_phases.control.type                      = dppp_inplace
{% if use_idg_predict %}
solve_fast_phases.control.mapfiles_in               = [create_timechunk_files_map.output.mapfile,create_fast_h5parms_map.output.mapfile,create_starttime_map.output.mapfile,create_ntimes_map.output.mapfile,create_fast_timestep_map.output.mapfile,create_fast_freqstep_map.output.mapfile]
solve_fast_phases.control.inputkeys                 = [msin,h5parm,starttime,ntimes,timestep,freqstep]
{% else %}
solve_fast_phases.control.mapfiles_in               = [create_timechunk_files_map.output.mapfile,create_fast_h5parms_map.output.mapfile,create_starttime_map.output.mapfile,create_ntimes_map.output.mapfile,create_fast_timestep_map.output.mapfile,create_fast_freqstep_map.output.mapfile,expand_sourcedb_mapfile_time.output.mapfile]
solve_fast_phases.control.inputkeys                 = [msin,h5parm,starttime,ntimes,timestep,freqstep,sourcedb]
{% endif %}
solve_fast_phases.control.max_per_node              = 1
solve_fast_phases.argument.numthreads               = {{ max_proc_per_node }}
solve_fast_phases.argument.msin.datacolumn          = {{ data_colname }}
solve_fast_phases.argument.msin.starttime           = starttime
solve_fast_phases.argument.msin.ntimes              = ntimes
solve_fast_phases.argument.msout                    = .
solve_fast_phases.argument.steps                    = [solve]
solve_fast_phases.argument.solve.type               = ddecal
solve_fast_phases.argument.solve.mode               = {{ mode }}
{% if mode == 'tecscreen' %}
solve_fast_phases.argument.solve.tecscreen.order    = {{ tecscreenorder }}
solve_fast_phases.argument.solve.tecscreen.mode     = station
{% endif %}
{% if use_beam %}
solve_fast_phases.argument.solve.usebeammodel       = True
solve_fast_phases.argument.solve.beammode           = array_factor
{% endif %}
solve_fast_phases.argument.solve.h5parm             = h5parm
solve_fast_phases.argument.solve.sourcedb           = sourcedb
solve_fast_phases.argument.solve.solint             = timestep
solve_fast_phases.argument.solve.nchan              = freqstep
{% if mode == 'tec' %}
solve_fast_phases.argument.solve.approximatetec     = {{ approximatetec }}
solve_fast_phases.argument.solve.maxapproxiter      = {{ maxapproxiter }}
# solve_fast_phases.argument.solve.approxchunksize    = 5
{% endif %}
solve_fast_phases.argument.solve.maxiter            = {{ maxiter }}
solve_fast_phases.argument.solve.propagatesolutions = {{ propagatesolutions }}
solve_fast_phases.argument.solve.stepsize           = {{ stepsize }}
solve_fast_phases.argument.solve.tolerance          = {{ tolerance }}
solve_fast_phases.argument.solve.uvlambdamin        = {{ solve_min_uv_lambda }}
{% if use_idg_predict %}
solve_fast_phases.argument.solve.useidg             = True
solve_fast_phases.argument.solve.idg.image          = {{ model_image_file }}
solve_fast_phases.argument.solve.idg.regions        = {{ model_regions_file }}
{% endif %}

# compress fast-phase mapfile so that all files are in one group, length = 1
create_compressed_mapfile_fast.control.kind        = plugin
create_compressed_mapfile_fast.control.type        = compressMapfile
create_compressed_mapfile_fast.control.mapfile_in  = create_fast_h5parms_map.output.mapfile
create_compressed_mapfile_fast.control.mapfile_dir = input.output.mapfile_dir
create_compressed_mapfile_fast.control.filename    = compress_fast.mapfile

# create a mapfile for output of combine step, length = 1
create_fast_output_map.control.kind        = plugin
create_fast_output_map.control.type        = addListMapfile
create_fast_output_map.control.hosts       = {{ hosts }}
create_fast_output_map.control.files       = [input.output.working_directory/input.output.job_name/fast_phases.h5]
create_fast_output_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_output_map.control.filename    = combine_fast_h5parms_output.mapfile

# collect all the fast-phase solutions, length = ntimechunks -> 1
combine_fast_phases.control.type        = collect_h5parms
combine_fast_phases.control.mapfile_in  = create_compressed_mapfile_fast.output.mapfile
combine_fast_phases.control.inputkey    = infiles
combine_fast_phases.control.mapfile_out = create_fast_output_map.output.mapfile
combine_fast_phases.control.outputkey   = outfile
combine_fast_phases.argument.flags      = [-c,infiles]
combine_fast_phases.argument.outh5parm  = outfile
{% if mode == 'tecscreen' %}
combine_fast_phases.argument.insoltab   = tec000
{% endif %}

{% endif %}

# fit screens to fast phases, length = 1
# TODO: better to reweight, then split h5parm to allow parallel processing of screen fitting
fit_fast_screens.control.type         = fit_tec_screens
fit_fast_screens.control.mapfile_in   = combine_fast_phases.output.mapfile
fit_fast_screens.control.inputkey     = infile
fit_fast_screens.argument.flags       = [infile]
fit_fast_screens.argument.order       = {{ tecscreenorder }}

# create a mapfile for output of a-term step, length = 1
create_fast_aterms_output_map.control.kind        = plugin
create_fast_aterms_output_map.control.type        = addListMapfile
create_fast_aterms_output_map.control.hosts       = {{ hosts }}
create_fast_aterms_output_map.control.files       = [input.output.working_directory/input.output.job_name/fast_aterms]
create_fast_aterms_output_map.control.mapfile_dir = input.output.mapfile_dir
create_fast_aterms_output_map.control.filename    = fast_aterms_output.mapfile

# make a-term images for IDG, length = 1
# TODO: split h5parm and process in parallel
make_fast_aterms.control.type         = make_aterm_images
make_fast_aterms.control.mapfile_in   = fit_fast_screens.output.mapfile
make_fast_aterms.control.inputkey     = infile
make_fast_aterms.control.mapfile_out  = create_fast_aterms_output_map.output.mapfile
make_fast_aterms.control.outputkey    = outroot
make_fast_aterms.argument.flags       = [infile,origtec000,outroot,{{ sector_bounds_deg }},{{ sector_bounds_mid_deg }}]
make_fast_aterms.argument.smooth      = 3
make_fast_aterms.argument.gsize       = 5
make_fast_aterms.argument.mapfile_dir = input.output.mapfile_dir
make_fast_aterms.argument.filename    = fast_aterms_images.mapfile

{% if do_slowgain_solve %}

# expand the fast-phase mapfile so that there is one entry for every frequency chunk, length = nfreqchunks*nobs
expand_fast_phases_mapfile.control.kind             = plugin
expand_fast_phases_mapfile.control.type             = expandMapfile
expand_fast_phases_mapfile.control.mapfile_in       = combine_fast_phases.output.mapfile
expand_fast_phases_mapfile.control.mapfile_to_match = create_freqchunk_files_map.output.mapfile
expand_fast_phases_mapfile.control.mapfile_dir      = input.output.mapfile_dir
expand_fast_phases_mapfile.control.filename         = expand_fastphase_freq.mapfile

# solve for slow gains, length = nfreqchunks*nobs
solve_slow_gains.control.type                           = dppp_inplace
{% if use_idg_predict %}
solve_slow_gains.control.mapfiles_in                    = [create_freqchunk_files_map.output.mapfile,create_slow_starttime_map.output.mapfile,create_slow_ntimes_map.output.mapfile,expand_fast_phases_mapfile.output.mapfile,create_slow_h5parms_map.output.mapfile,create_startchan_map.output.mapfile,create_nchan_map.output.mapfile,create_slow_timestep_map.output.mapfile,create_slow_freqstep_map.output.mapfile]
solve_slow_gains.control.inputkeys                      = [msin,starttime,ntimes,fast_h5parm,slow_h5parm,startchan,nchan,timestep,freqstep]
{% else %}
solve_slow_gains.control.mapfiles_in                    = [create_freqchunk_files_map.output.mapfile,create_slow_starttime_map.output.mapfile,create_slow_ntimes_map.output.mapfile,expand_fast_phases_mapfile.output.mapfile,create_slow_h5parms_map.output.mapfile,create_startchan_map.output.mapfile,create_nchan_map.output.mapfile,create_slow_timestep_map.output.mapfile,create_slow_freqstep_map.output.mapfile,expand_sourcedb_mapfile_freq.output.mapfile]
solve_slow_gains.control.inputkeys                      = [msin,starttime,ntimes,fast_h5parm,slow_h5parm,startchan,nchan,timestep,freqstep,sourcedb]
{% endif %}
solve_slow_gains.control.max_per_node                   = 1
solve_slow_gains.argument.numthreads                    = {{ max_proc_per_node }}
solve_slow_gains.argument.msin.datacolumn               = {{ data_colname }}
solve_slow_gains.argument.msin.starttime                = starttime
solve_slow_gains.argument.msin.ntimes                   = ntimes
solve_slow_gains.argument.msin.startchan                = startchan
solve_slow_gains.argument.msin.nchan                    = nchan
solve_slow_gains.argument.msout                         = .
solve_slow_gains.argument.steps                         = [solve]
solve_slow_gains.argument.solve.type                    = ddecal
solve_slow_gains.argument.solve.mode                    = complexgain
solve_slow_gains.argument.solve.h5parm                  = slow_h5parm
solve_slow_gains.argument.solve.sourcedb                = sourcedb
solve_slow_gains.argument.solve.solint                  = timestep
solve_slow_gains.argument.solve.nchan                   = freqstep
solve_slow_gains.argument.solve.propagatesolutions      = {{ propagatesolutions }}
solve_slow_gains.argument.solve.applycal.parmdb         = fast_h5parm
solve_slow_gains.argument.solve.applycal.steps          = [tec]
solve_slow_gains.argument.solve.applycal.tec.correction = origtec000
{% if use_beam %}
solve_slow_gains.argument.solve.usebeammodel            = True
solve_slow_gains.argument.solve.beammode                = array_factor
{% endif %}
solve_slow_gains.argument.solve.uvlambdamin             = {{ solve_min_uv_lambda }}
solve_slow_gains.argument.solve.smoothnessconstraint    = {{ smoothnessconstraint }}
solve_slow_gains.argument.solve.maxiter                 = {{ maxiter }}
solve_slow_gains.argument.solve.tolerance               = {{ tolerance }}
solve_slow_gains.argument.msout.storagemanager          = "Dysco"
{% if use_idg_predict %}
solve_slow_gains.argument.solve.useidg                  = True
solve_slow_gains.argument.solve.idg.image               = {{ model_image_file }}
solve_slow_gains.argument.solve.idg.regions             = {{ model_regions_file }}
{% endif %}

# compress slow-gain mapfile so that all files are in one group, length = 1
create_compressed_mapfile_slow.control.kind        = plugin
create_compressed_mapfile_slow.control.type        = compressMapfile
create_compressed_mapfile_slow.control.mapfile_in  = create_slow_h5parms_map.output.mapfile
create_compressed_mapfile_slow.control.mapfile_dir = input.output.mapfile_dir
create_compressed_mapfile_slow.control.filename    = compress_slow.mapfile

# create a mapfile for output of combine step, length = 1
create_slow_output_map.control.kind        = plugin
create_slow_output_map.control.type        = addListMapfile
create_slow_output_map.control.hosts       = {{ hosts }}
create_slow_output_map.control.files       = [input.output.working_directory/input.output.job_name/slow_gains.h5]
create_slow_output_map.control.mapfile_dir = input.output.mapfile_dir
create_slow_output_map.control.filename    = combine_slow_h5parms_output.mapfile

# collect all the slow-gain solutions, length = nfreqchunks*nobs -> 1
combine_slow_gains.control.type        = collect_h5parms
combine_slow_gains.control.mapfile_in  = create_compressed_mapfile_slow.output.mapfile
combine_slow_gains.control.inputkey    = infiles
combine_slow_gains.control.mapfile_out = create_slow_output_map.output.mapfile
combine_slow_gains.control.outputkey   = outfile
combine_slow_gains.argument.flags      = [-c,infiles]
combine_slow_gains.argument.outh5parm  = outfile

# fit screens to slow gains, length = 1
# TODO: better to reweight, then split h5parm to allow parallel processing of screen fitting
fit_slow_screens.control.type         = fit_gain_screens
fit_slow_screens.control.mapfile_in   = combine_slow_gains.output.mapfile
fit_slow_screens.control.inputkey     = infile
fit_slow_screens.argument.flags       = [infile]

# create a mapfile for output of a-term step, length = 1
create_slow_aterms_output_map.control.kind        = plugin
create_slow_aterms_output_map.control.type        = addListMapfile
create_slow_aterms_output_map.control.hosts       = {{ hosts }}
create_slow_aterms_output_map.control.files       = [input.output.working_directory/input.output.job_name/slow_aterms]
create_slow_aterms_output_map.control.mapfile_dir = input.output.mapfile_dir
create_slow_aterms_output_map.control.filename    = slow_aterms_output.mapfile

# make a-term images for IDG, length = 1
# TODO: split h5parm and process in parallel
make_slow_aterms.control.type         = make_aterm_images
make_slow_aterms.control.mapfile_in   = fit_slow_screens.output.mapfile
make_slow_aterms.control.inputkey     = infile
make_slow_aterms.control.mapfile_out  = create_slow_aterms_output_map.output.mapfile
make_slow_aterms.control.outputkey    = outfile
make_slow_aterms.argument.flags       = [infile,gain000,outfile,{{ sector_bounds_deg }},{{ sector_bounds_mid_deg }}]
make_slow_aterms.argument.smooth      = 3
make_slow_aterms.argument.gsize       = 5
make_slow_aterms.argument.mapfile_dir = input.output.mapfile_dir
make_slow_aterms.argument.filename    = slow_aterms_images.mapfile

# create a mapfile for output of combine step, length = 1
create_combined_output_map.control.kind        = plugin
create_combined_output_map.control.type        = addListMapfile
create_combined_output_map.control.hosts       = {{ hosts }}
create_combined_output_map.control.files       = [input.output.working_directory/input.output.job_name/combined_solutions.h5]
create_combined_output_map.control.mapfile_dir = input.output.mapfile_dir
create_combined_output_map.control.filename    = combine_all_h5parms_output.mapfile

# combine fast and slow h5parms, length = 2 -> 1
combine_h5parms.control.type        = combine_h5parms
combine_h5parms.control.mapfiles_in = [combine_fast_phases.output.mapfile,combine_slow_gains.output.mapfile]
combine_h5parms.control.inputkeys   = [h1,h2]
combine_h5parms.control.mapfile_out = create_combined_output_map.output.mapfile
combine_h5parms.control.outputkey   = outfile
combine_h5parms.argument.flags      = [h1,h2,outfile]

{% endif %}

